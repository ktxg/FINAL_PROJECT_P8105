---
title: "Untitled"
author: "Katie Gao"
date: "11/19/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(plotly)
library(viridis)
```

TEST 123
testing 

```{r}
h1b_2018 = read.csv(file = "./data/dataset.csv")  
## this is a test to read and open the dataset
## I created a folder in our project called "data" 

## then inside it I downloaded the dataset and called it "dataset.csv" 

## then inside it I downloaded the dataset and called it "dataset.csv"


####select the 16 variables which we are interested in
h1b_18_filter = h1b_2018 %>% 
  janitor::clean_names() %>% 
  select(case_number, visa_class, case_status, employer_name, employer_country, employer_city, employer_state,
         naics_code, soc_code, soc_name, total_workers, employment_start_date, employment_end_date, full_time_position,
         prevailing_wage, pw_unit_of_pay, worksite_city, worksite_state, h1b_dependent) %>%
  filter(case_status == "CERTIFIED",
          visa_class == "H-1B",
          employer_country == "UNITED STATES OF AMERICA") %>% 
  select(-visa_class, -case_status, -employer_country)



```

```{r}
library(ggplot2)
library(plotly)
```

```{r}
h1b_18_filter%>%
  group_by(employer_state) %>%
  summarize(state_n = n())
```


```{r}
h1b_18_filter %>%
  group_by(employer_state) %>%
  summarize(state_n = n())%>%
  filter(state_n > 5000)%>%
ggplot(aes(x=employer_state, y=state_n)) +
  geom_bar(stat="identity") +
  theme(text = element_text(size=12),
         axis.text.x = element_text(angle=90, vjust=0.5)) +
  labs(
    title = "Cases by state",
    x = "State",
    y = "Number of cases in each state"
  )
```
```


```{r}
state_number = 
  h1b_2018 %>%
  group_by(employer_state) %>%
  summarize(n = n())

state_number$hover <- with(state_number, paste("State", employer_state, "<br>", "Number", n))

l <- list(color = toRGB("white"), width = 2)

g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

p <- plot_geo(state_number, locationmode = 'USA-states') %>%
  add_trace(
    z = ~n, text = ~hover, locations = ~employer_state,
    color = ~n, colors = 'Purples'
  ) %>%
  colorbar(title = "Millions USD") %>%
  layout(
    title = '2018 US H1b by State',
    geo = g
  )

p
```



```{r}
h1b_location =
  h1b_18_filter %>% 
  select(case_number, employer_city, employer_state, worksite_city, worksite_state) 

h1b_location_50 = h1b_location %>% 
  filter(employer_state != c("DC", "GU",  "MP", "PR", "VI"))

h1b_location_commonwealth =  h1b_location %>% 
  filter(employer_state == c("DC", "GU",  "MP", "PR", "VI"))

h1b_location_50 %>% 
  group_by(employer_state) %>% 
  summarize(n = n()) %>% 
  mutate(employer_state = fct_reorder(employer_state, n)) %>% 
  plot_ly(x = ~employer_state, y = ~n, color = ~employer_state, type = "bar")

h1b_location_commonwealth %>% 
  group_by(employer_state) %>% 
  summarize(n = n()) %>% 
  mutate(employer_state = fct_reorder(employer_state, n)) %>% 
  plot_ly(x = ~employer_state, y = ~n, color = ~employer_state, type = "bar")

```





